{
  "version": 3,
  "sources": ["../../src/lib/mqttServer.ts"],
  "sourcesContent": ["import type { Server as NetServer, Socket } from 'node:net';\r\n// eslint-disable-next-line no-duplicate-imports\r\nimport net from 'node:net';\r\n\r\nimport type { MqttClient, Packet } from 'mqtt-connection';\r\n// eslint-disable-next-line no-duplicate-imports\r\nimport mqttCon from 'mqtt-connection';\r\n\r\nimport type { MqttConnectEvent, MqttMessageEvent, MqttEventCallback } from './mqtt-events';\r\n\r\ntype MqttClient = typeof MqttClient;\r\ntype Packet = typeof Packet;\r\n\r\nexport interface MqttServerOptions {\r\n    port?: number;\r\n    host?: string;\r\n}\r\n\r\nexport class MqttServer /*extends EventEmitter*/ {\r\n    private server: NetServer;\r\n    private port: number;\r\n    private host: string;\r\n    //private adapter: ioBroker.Adapter;\r\n    private log: ioBroker.Log;\r\n    private mqttEventCallback: MqttEventCallback;\r\n\r\n    constructor(adapter: ioBroker.Adapter, options: MqttServerOptions = {}, callback: MqttEventCallback) {\r\n        //super();\r\n        this.log = adapter.log;\r\n        this.host = options.host ?? '0.0.0.0';\r\n        this.port = options.port ?? 1883;\r\n\r\n        this.log.silly(`[MQTT-Server] init server at ${this.host}:${this.port}`);\r\n        this.server = net.createServer(this.handleConnection.bind(this));\r\n\r\n        this.mqttEventCallback = callback;\r\n    }\r\n\r\n    private handleConnection(stream: Socket): void {\r\n        const remoteAddress = stream.remoteAddress || 'unknown';\r\n        this.log.silly(`[MQTT-Server] client connect from  ${remoteAddress}`);\r\n\r\n        const client: MqttClient = mqttCon(stream);\r\n        let clientId: any;\r\n\r\n        client.on('connect', async (packet: Packet) => {\r\n            clientId = packet.clientId;\r\n            this.log.silly(\r\n                `[MQTT-Server] (${clientId}) client connected with id ${packet.clientId} connected from ${remoteAddress}`,\r\n            );\r\n\r\n            // Acknowledge connection\r\n            client.connack({ returnCode: 0 });\r\n\r\n            // report connection\r\n            await this.mqttEventCallback('connect', {\r\n                clientId: packet.clientId,\r\n                ip: remoteAddress,\r\n                packet,\r\n            } as MqttConnectEvent);\r\n        });\r\n\r\n        client.on('publish', async (packet: Packet) => {\r\n            this.log.silly(\r\n                `[MQTT-Server] (${clientId}) received message on topic \"${packet.topic}\": ${packet.payload?.toString()}`,\r\n            );\r\n\r\n            if (packet.qos && packet.qos > 0) {\r\n                client.puback({ messageId: packet.messageId });\r\n            }\r\n\r\n            // report message\r\n            await this.mqttEventCallback('message', {\r\n                clientId: client.id || '',\r\n                ip: remoteAddress,\r\n                topic: packet.topic,\r\n                payload: packet.payload,\r\n                qos: packet.qos ?? 0,\r\n                retain: packet.retain ?? false,\r\n                packet,\r\n            } as MqttMessageEvent);\r\n        });\r\n\r\n        client.on('subscribe', (packet: Packet) => {\r\n            packet.subscriptions.forEach((sub: any) => {\r\n                this.log.silly(`[MQTT-Server] (${clientId}) client ${packet.clientId} subscribed to \"${sub.topic}\"`);\r\n            });\r\n            // Grant all requested QoS levels\r\n            client.suback({\r\n                granted: packet.subscriptions.map((sub: any) => sub.qos ?? 0),\r\n                messageId: client._lastSubscriptionId || 1,\r\n            });\r\n        });\r\n\r\n        client.on('unsubscribe', (unsubscriptions: any[]) => {\r\n            unsubscriptions.forEach(topic => {\r\n                this.log.silly(`[MQTT-Server] (${clientId}) client unsubscribed from \"${topic}\"`);\r\n            });\r\n            client.unsuback({ messageId: client._lastUnsubscribeId || 1 });\r\n        });\r\n\r\n        client.on('pingreq', () => {\r\n            this.log.silly(`[MQTT-Server] (${clientId}) client ping`);\r\n            client.pingresp();\r\n        });\r\n\r\n        client.on('disconnect', () => {\r\n            this.log.silly(`[MQTT-Server] (${clientId}) client disconnect from  ${remoteAddress}`);\r\n            client.stream.end();\r\n        });\r\n\r\n        client.on('close', () => {\r\n            this.log.silly(`[MQTT-Server] (${clientId}) client ${remoteAddress} closed connection`);\r\n        });\r\n\r\n        client.on('error', (err: any) => {\r\n            this.log.error(`[MQTT-Server] (${clientId}) client error  ${err}`);\r\n            client.stream.end();\r\n        });\r\n    }\r\n\r\n    public async start(): Promise<void> {\r\n        await new Promise<void>((resolve, reject) => {\r\n            this.server.listen(this.port, this.host, () => {\r\n                this.log.info(`MQTT server is running on ${this.host}:${this.port}`);\r\n                resolve();\r\n            });\r\n            this.server.on('error', err => reject(err));\r\n        });\r\n    }\r\n\r\n    public async stop(): Promise<void> {\r\n        await new Promise<void>((resolve, reject) => {\r\n            this.server.close((err?: Error) => {\r\n                if (err) {\r\n                    reject(err);\r\n                } else {\r\n                    this.log.info('MQTT server stopped.');\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": ["net", "mqttCon"]
}
